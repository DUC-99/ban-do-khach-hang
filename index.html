<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>B·∫£n ƒë·ªì kh√°ch h√†ng - SUKIN</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: sans-serif;
      /* ‚úÖ Cho ph√©p copy n·ªôi dung */
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
    }

    #mapContainer { height: 100%; width: 100%; overflow: hidden; position: relative; }
    #map { height: 100%; width: 100%; }

    #searchBox {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: white;
      padding: 6px;
      border-radius: 6px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.4);
    }

    #searchInput {
      width: 320px;
      max-width: 80vw;
      padding: 6px;
      font-size: 14px;
      border: 1px solid #aaa;
      border-radius: 4px;
    }

    #sheetButtons {
      position: absolute;
      top: 60px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
      background: rgba(255,255,255,0.9);
      padding: 5px 10px;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.3);
    }

    .sheet-btn {
      border: 1px solid #007bff;
      background: white;
      padding: 5px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      color: #007bff;
    }

    .sheet-btn.active {
      background: #007bff;
      color: white;
    }

    .contract-label {
      background-color: white;
      padding: 2px 6px;
      border-radius: 4px;
      border: 1px solid #666;
      font-weight: bold;
      font-size: 13px;
      white-space: nowrap;
      pointer-events: none;
      box-shadow: 1px 1px 2px rgba(0,0,0,0.3);
      transform: translate(-50%, -50px);
      position: absolute;
      z-index: 700;
    }

    #gotoHCM {
      position: absolute;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      background: white;
      border: none;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      font-size: 22px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #gotoHCM:hover { background: #f0f0f0; }

    .control-btn {
      position: absolute;
      z-index: 1000;
      background: white;
      border: 1px solid #007bff;
      border-radius: 20px;
      padding: 8px 14px;
      font-size: 14px;
      color: #007bff;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    #toggleTracking { left: 20px; bottom: 20px; }

    .control-btn.active { background: #007bff; color: white; border-color: #0062d6; }

    /* ‚úÖ Cho ph√©p ch·ªçn v√† copy n·ªôi dung trong popup */
    .leaflet-popup-content {
      user-select: text !important;
      -webkit-user-select: text !important;
      -moz-user-select: text !important;
    }
  </style>
</head>
<body>
  <div id="searchBox">
    <input type="text" id="searchInput" placeholder="üîç T√¨m m√£ Hƒê, ƒë·ªãa ch·ªâ ho·∫∑c kh√°ch h√†ng (Enter ƒë·ªÉ t√¨m)...">
  </div>

  <div id="sheetButtons">
    <button class="sheet-btn active" data-sheet="SUKIN 1">SUKIN 1</button>
    <button class="sheet-btn" data-sheet="SUKIN 2">SUKIN 2</button>
    <button class="sheet-btn" data-sheet="SUKIN 3">SUKIN 3</button>
    <button class="sheet-btn" data-sheet="SUKIN 4">SUKIN 4</button>
  </div>

  <div id="mapContainer"><div id="map"></div></div>
  <button id="gotoHCM" title="V·ªÅ TP.HCM">üìç</button>
  <button id="toggleTracking" class="control-btn" title="B·∫≠t/t·∫Øt ƒë·ªãnh v·ªã">B·∫≠t GPS</button>

  <script>
    const DATA_BASE_URL = "https://script.google.com/macros/s/AKfycbzLgLyzQ2bF0VKIMo8eaK7nRM-IbqevAWiq-xF75bmoA1muGvE0nyHbAiDvgyH3Gx3RmA/exec";
    const map = L.map("map").setView([10.776, 106.7], 11);

    let markers = [];
    let currentLocationMarker = null;
    let currentLocationCircle = null;
    let watchId = null;

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const getIcon = (color = "blue") => L.icon({
      iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-${color}.png`,
      shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41],
    });

    const currentLocationIcon = L.icon({
      iconUrl: "https://cdn-icons-png.flaticon.com/512/64/64113.png",
      iconSize: [32, 32],
      iconAnchor: [16, 32],
      popupAnchor: [0, -32],
    });

    function isOlderThan10Days(dateStr) {
      if (!dateStr) return true;
      const parts = dateStr.split(/[\/\-]/);
      const [day, month, year] = dateStr.includes("/") ? parts.map(Number) : [parts[2], parts[1], parts[0]].map(Number);
      const date = new Date(year, month - 1, day);
      if (isNaN(date)) return true;
      return (new Date() - date) / (1000 * 60 * 60 * 24) > 10;
    }

    function isToday(dateStr) {
      if (!dateStr) return false;
      const parts = dateStr.split(/[\/\-]/);
      const [day, month, year] = dateStr.includes("/") ? parts.map(Number) : [parts[2], parts[1], parts[0]].map(Number);
      const date = new Date(year, month - 1, day);
      const today = new Date();
      return date.getDate() === today.getDate() && date.getMonth() === today.getMonth() && date.getFullYear() === today.getFullYear();
    }

    function getPopupContent(marker) {
      const d = marker.customData || {};
      return `
        <div style="line-height:1.5; font-size:14px;">
          <b>üÜî M√É H·ª¢P ƒê·ªíNG:</b> ${d.mahd || "‚Äî"}<br>
          üë§ <b>KH√ÅCH H√ÄNG:</b> ${d.hoten || "‚Äî"}<br>
          üí¨ <b>M0:</b> ${d.m0 || "‚Äî"}<br>
          üè† <b>ƒê·ªäA CH·ªà:</b> ${d.diachi || "‚Äî"}<br>
          üìÖ <b>NG√ÄY ƒêI:</b> ${d.ngaydi || "‚Äî"}<br>
          üë∑ <b>NH√ÇN VI√äN:</b> ${d.nguoidi || "‚Äî"}<br>
          üìù <b>GHI CH√ö:</b> ${d.ghichu || "‚Äî"}<br>
          üåê <b>T·ªåA ƒê·ªò:</b> ${d.lat}, ${d.lng}
        </div>`;
    }

    function addContractLabel(marker) {
      const label = L.DomUtil.create("div", "contract-label");
      label.innerText = marker.customData.mahd || "";
      label.style.borderColor = marker.customData.color || "blue";
      map.getPanes().overlayPane.appendChild(label);
      function updatePos() {
        const pos = map.latLngToLayerPoint(marker.getLatLng());
        label.style.left = `${pos.x}px`;
        label.style.top = `${pos.y - 18}px`;
      }
      updatePos();
      map.on("zoom move", updatePos);
      marker.on("remove", () => label.remove());
    }

    async function loadData(sheet = "SUKIN 1") {
      markers.forEach(m => m.remove?.());
      markers = [];
      const res = await fetch(`${DATA_BASE_URL}?sheet=${encodeURIComponent(sheet)}`);
      const data = await res.json();
      data.forEach(item => {
        const lat = parseFloat(item.lat), lng = parseFloat(item.lng);
        if (isNaN(lat) || isNaN(lng)) return;
        let color = isToday(item.ngaydi) ? "green" : isOlderThan10Days(item.ngaydi) ? "red" : "blue";
        const marker = L.marker([lat, lng], { icon: getIcon(color) }).addTo(map);
        marker.customData = { ...item, lat, lng, color };
        marker.bindPopup(getPopupContent(marker));
        addContractLabel(marker);
        markers.push(marker);
      });
    }

    function setupSmartSearch() {
      const input = document.getElementById("searchInput");
      input.addEventListener("keydown", e => {
        if (e.key !== "Enter") return;
        const q = input.value.trim().toLowerCase();
        if (!q) return;
        let found = false;
        markers.forEach(m => {
          const text = `${m.customData.mahd} ${m.customData.hoten} ${m.customData.diachi}`.toLowerCase();
          if (text.includes(q)) {
            map.setView(m.getLatLng(), 15);
            m.openPopup();
            found = true;
          }
        });
        if (!found) alert("‚ùå Kh√¥ng t√¨m th·∫•y th√¥ng tin ph√π h·ª£p.");
      });
    }

    function startTracking() {
      if (!navigator.geolocation) return alert("Thi·∫øt b·ªã kh√¥ng h·ªó tr·ª£ GPS");
      if (watchId) return;
      watchId = navigator.geolocation.watchPosition(
        pos => {
          const { latitude: lat, longitude: lng, accuracy } = pos.coords;
          if (!currentLocationMarker) {
            currentLocationMarker = L.marker([lat, lng], { icon: currentLocationIcon }).addTo(map).bindPopup("üìç B·∫°n ƒëang ·ªü ƒë√¢y");
            currentLocationCircle = L.circle([lat, lng], { radius: accuracy, color: "#136AEC", fillColor: "#136AEC", fillOpacity: 0.15 }).addTo(map);
            map.setView([lat, lng], 15);
          } else {
            currentLocationMarker.setLatLng([lat, lng]);
            currentLocationCircle.setLatLng([lat, lng]).setRadius(accuracy);
          }
        },
        err => console.error("GPS error:", err),
        { enableHighAccuracy: true, maximumAge: 1000, timeout: 10000 }
      );
    }

    function stopTracking() {
      if (watchId) navigator.geolocation.clearWatch(watchId);
      watchId = null;
      if (currentLocationMarker) map.removeLayer(currentLocationMarker);
      if (currentLocationCircle) map.removeLayer(currentLocationCircle);
      currentLocationMarker = null;
      currentLocationCircle = null;
    }

    function setupButtons() {
      document.querySelectorAll(".sheet-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          document.querySelectorAll(".sheet-btn").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          loadData(btn.dataset.sheet);
        });
      });
      document.getElementById("gotoHCM").onclick = () => map.setView([10.776, 106.7], 12);
      const toggle = document.getElementById("toggleTracking");
      toggle.onclick = () => {
        if (watchId) { stopTracking(); toggle.classList.remove("active"); toggle.textContent = "B·∫≠t GPS"; }
        else { startTracking(); toggle.classList.add("active"); toggle.textContent = "T·∫Øt GPS"; }
      };
    }

    window.onload = () => {
      loadData("SUKIN 1");
      setupSmartSearch();
      setupButtons();
    };
  </script>
</body>
</html>
