<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Báº£n Ä‘á»“ khÃ¡ch hÃ ng - SUKIN</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html, body { height: 100%; margin: 0; font-family: sans-serif; -webkit-user-select:none; -webkit-touch-callout:none; }
    #mapContainer { height: 100%; width: 100%; overflow: hidden; position: relative; }
    #map { height: 100%; width: 100%; }

    #searchBox {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: white;
      padding: 6px;
      border-radius: 6px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.4);
    }

    #searchInput {
      width: 320px;
      max-width: 80vw;
      padding: 6px;
      font-size: 14px;
      border: 1px solid #aaa;
      border-radius: 4px;
    }

    #sheetButtons {
      position: absolute;
      top: 60px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
      background: rgba(255,255,255,0.9);
      padding: 5px 10px;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.3);
    }

    .sheet-btn {
      border: 1px solid #007bff;
      background: white;
      padding: 5px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      color: #007bff;
    }

    .sheet-btn.active {
      background: #007bff;
      color: white;
    }

    .contract-label {
      background-color: white;
      padding: 2px 6px;
      border-radius: 4px;
      border: 1px solid #666;
      font-weight: bold;
      font-size: 13px;
      white-space: nowrap;
      pointer-events: none;
      user-select: none;
      box-shadow: 1px 1px 2px rgba(0,0,0,0.3);
      transform: translate(-50%, -50px);
      position: absolute;
      z-index: 700;
    }

    #gotoHCM {
      position: absolute;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      background: white;
      border: none;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      font-size: 22px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #gotoHCM:hover { background: #f0f0f0; }

    .control-btn {
      position: absolute;
      z-index: 1000;
      background: white;
      border: 1px solid #007bff;
      border-radius: 20px;
      padding: 8px 14px;
      font-size: 14px;
      color: #007bff;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    #toggleTracking { left: 20px; bottom: 20px; }

    .control-btn.active { background: #007bff; color: white; border-color: #0062d6; }
  </style>
</head>
<body>
  <div id="searchBox">
    <input type="text" id="searchInput" placeholder="ğŸ” TÃ¬m mÃ£ HÄ, Ä‘á»‹a chá»‰ hoáº·c khÃ¡ch hÃ ng (Enter Ä‘á»ƒ tÃ¬m)...">
  </div>

  <div id="sheetButtons">
    <button class="sheet-btn active" data-sheet="SUKIN 1">SUKIN 1</button>
    <button class="sheet-btn" data-sheet="SUKIN 2">SUKIN 2</button>
    <button class="sheet-btn" data-sheet="SUKIN 3">SUKIN 3</button>
    <button class="sheet-btn" data-sheet="SUKIN 4">SUKIN 4</button>
  </div>

  <div id="mapContainer">
    <div id="map"></div>
  </div>

  <button id="gotoHCM" title="Vá» TP.HCM">ğŸ“</button>
  <button id="toggleTracking" class="control-btn" title="Báº­t/táº¯t Ä‘á»‹nh vá»‹">Báº­t GPS</button>

  <script>
    const DATA_BASE_URL = "https://script.google.com/macros/s/AKfycbzLgLyzQ2bF0VKIMo8eaK7nRM-IbqevAWiq-xF75bmoA1muGvE0nyHbAiDvgyH3Gx3RmA/exec";

    const map = L.map("map", { zoomControl: true }).setView([10.776, 106.7], 11);
    const mapContainer = document.getElementById("mapContainer");

    let markers = [];
    let currentLocationMarker = null;
    let currentLocationCircle = null;
    let watchId = null;

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const getIcon = (color = "blue") => L.icon({
      iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-${color}.png`,
      shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41],
    });

    const currentLocationIcon = L.icon({
      iconUrl: "https://cdn-icons-png.flaticon.com/512/64/64113.png",
      iconSize: [32, 32],
      iconAnchor: [16, 32],
      popupAnchor: [0, -32],
    });

    function isOlderThan10Days(dateStr) {
      if (!dateStr || dateStr.trim() === "") return true;
      const parts = dateStr.split(/[\/\-]/);
      let day, month, year;
      if (dateStr.includes("/")) [day, month, year] = parts.map(p => parseInt(p));
      else [year, month, day] = parts.map(p => parseInt(p));
      const date = new Date(year, month - 1, day);
      if (isNaN(date)) return true;
      const diff = (new Date() - date) / (1000 * 60 * 60 * 24);
      return diff > 10;
    }

    function getPopupContent(marker) {
      const d = marker.customData || {};
      return `
        <div style="line-height:1.4; font-size:14px;">
          <b>ğŸ†” MÃƒ Há»¢P Äá»’NG:</b> ${d.mahd || "â€”"}<br>
          ğŸ‘¤ <b>KHÃCH HÃ€NG:</b> ${d.hoten || "â€”"}<br>
          ğŸ’¬ <b>M0:</b> ${d.m0 || "â€”"}<br>
          ğŸ  <b>Äá»ŠA CHá»ˆ:</b> ${d.diachi || "â€”"}<br>
          ğŸ“… <b>NGÃ€Y ÄI:</b> ${d.ngaydi || "â€”"}<br>
          ğŸ‘· <b>NHÃ‚N VIÃŠN:</b> ${d.nguoidi || "â€”"}<br>
          ğŸ“ <b>GHI CHÃš:</b> ${d.ghichu || "â€”"}<br>
          ğŸŒ <b>Tá»ŒA Äá»˜:</b> ${d.lat}, ${d.lng}
        </div>`;
    }

    function addContractLabel(marker) {
      const label = L.DomUtil.create("div", "contract-label");
      label.innerText = marker.customData.mahd || "";
      label.style.borderColor = marker.customData.color || "blue";
      map.getPanes().overlayPane.appendChild(label);
      function updatePos() {
        const pos = map.latLngToLayerPoint(marker.getLatLng());
        label.style.left = `${pos.x}px`;
        label.style.top = `${pos.y - 18}px`;
      }
      updatePos();
      map.on("zoom move", updatePos);
      marker.on("remove", () => label.remove());
    }

    async function loadData(sheet = "SUKIN 1") {
      try {
        markers.forEach(m => m.remove?.());
        markers = [];

        const res = await fetch(`${DATA_BASE_URL}?sheet=${encodeURIComponent(sheet)}`);
        const data = await res.json();

        data.forEach(item => {
          const lat = parseFloat(item.lat);
          const lng = parseFloat(item.lng);
          if (isNaN(lat) || isNaN(lng)) return;
          const color = isOlderThan10Days(item.ngaydi) ? "red" : "blue";
          const marker = L.marker([lat, lng], { icon: getIcon(color) }).addTo(map);
          marker.customData = { ...item, lat, lng, color };
          marker.bindPopup(getPopupContent(marker));
          addContractLabel(marker);
          markers.push(marker);
        });
      } catch (err) {
        alert("Lá»—i khi táº£i dá»¯ liá»‡u.");
      }
    }

    function setupSmartSearch() {
      const input = document.getElementById("searchInput");
      input.addEventListener("keydown", (e) => {
        if (e.key !== "Enter") return;
        const query = input.value.trim().toLowerCase();
        if (!query) return;
        let found = false;
        markers.forEach(m => {
          const t = `${m.customData.mahd} ${m.customData.hoten} ${m.customData.diachi}`.toLowerCase();
          if (t.includes(query)) {
            map.setView(m.getLatLng(), 15);
            m.openPopup();
            found = true;
          }
        });
        if (!found) alert("âŒ KhÃ´ng tÃ¬m tháº¥y thÃ´ng tin phÃ¹ há»£p.");
      });
    }

    function startTracking() {
      if (!navigator.geolocation) {
        alert("Thiáº¿t bá»‹ khÃ´ng há»— trá»£ GPS");
        return;
      }
      if (watchId) return;
      watchId = navigator.geolocation.watchPosition(
        pos => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          const accuracy = pos.coords.accuracy;
          if (!currentLocationMarker) {
            currentLocationMarker = L.marker([lat, lng], { icon: currentLocationIcon })
              .addTo(map)
              .bindPopup("ğŸ“ Báº¡n Ä‘ang á»Ÿ Ä‘Ã¢y");
            currentLocationCircle = L.circle([lat, lng], {
              radius: accuracy,
              color: "#136AEC",
              fillColor: "#136AEC",
              fillOpacity: 0.15
            }).addTo(map);
            map.setView([lat, lng], 15);
          } else {
            currentLocationMarker.setLatLng([lat, lng]);
            currentLocationCircle.setLatLng([lat, lng]);
            currentLocationCircle.setRadius(accuracy);
          }
        },
        err => console.error("GPS error:", err),
        { enableHighAccuracy: true, maximumAge: 1000, timeout: 10000 }
      );
    }

    function stopTracking() {
      if (watchId) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
      if (currentLocationMarker) map.removeLayer(currentLocationMarker);
      if (currentLocationCircle) map.removeLayer(currentLocationCircle);
      currentLocationMarker = null;
      currentLocationCircle = null;
    }

    document.getElementById("gotoHCM").addEventListener("click", () => {
      map.flyTo([10.776, 106.700], 12);
    });

    const gpsBtn = document.getElementById("toggleTracking");
    gpsBtn.addEventListener("click", () => {
      if (gpsBtn.classList.contains("active")) {
        gpsBtn.classList.remove("active");
        gpsBtn.innerText = "Báº­t GPS";
        stopTracking();
      } else {
        gpsBtn.classList.add("active");
        gpsBtn.innerText = "Táº¯t GPS";
        startTracking();
      }
    });

    document.querySelectorAll(".sheet-btn").forEach(btn => {
      btn.addEventListener("click", async () => {
        document.querySelectorAll(".sheet-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        await loadData(btn.dataset.sheet);
      });
    });

    window.addEventListener('load', async () => {
      await loadData("SUKIN 1");
      setupSmartSearch();
    });

    window.addEventListener('resize', () => setTimeout(() => map.invalidateSize(), 120));
  </script>
</body>
</html>
