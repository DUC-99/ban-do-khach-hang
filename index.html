<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Bản đồ khách hàng</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }
    #searchBox {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: white;
      padding: 6px;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }
    #searchBox input {
      width: 250px;
    }
    .popup-btns button {
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      margin-left: 5px;
    }
  </style>
</head>
<body>
  <div id="searchBox">
    <input type="text" id="searchInput" placeholder="Tìm theo mã hợp đồng, tên hoặc địa chỉ..." />
  </div>
  <div id="map"></div>

  <script>
    const DATA_URL = "https://script.google.com/macros/s/AKfycbwA7VH_IbTiYpNjXIUX-stMmOSLWiXqRZ4h7Fzc-xMJmVqUPIQn-B37PMkngLH_AOyc/exec";
    const COLORS = ["blue", "red", "green", "yellow", "violet", "black", "grey"];
    const COLOR_NAMES = {
      blue: "Xanh dương",
      red: "Đỏ",
      green: "Xanh lá",
      yellow: "Vàng",
      violet: "Tím",
      black: "Đen",
      grey: "Xám"
    };

    let map = L.map("map").setView([10.776, 106.7], 11);
    let markers = [];
    let destinationMarker = null;

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    function getIcon(color = "blue") {
      return L.icon({
        iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-${color}.png`,
        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      });
    }

    function getPopupContent(marker) {
      const { name, address, contract, lat, lng, image, color } = marker.customData;

      const colorButtons = COLORS.map(c => `
        <button 
          onclick="applyColor('${c}', ${lat}, ${lng})"
          style="background:${c}; width:20px; height:20px; border-radius:50%; border:1px solid #ccc; margin-right:4px;"
          title="${COLOR_NAMES[c]}"
        ></button>
      `).join("");

      return `
        <b>${name || "Chưa có tên"}</b><br>
        🆔 Mã HĐ: ${contract || "Không có"}<br>
        📍 ${address}<br>
        🌐 ${lat.toFixed(5)}, ${lng.toFixed(5)}<br>
        ${image ? `<img src="${image}" width="180"><br>` : ""}
        <div style="margin-top:5px"><b>Chọn màu:</b><br>${colorButtons}</div>
        <div class="popup-btns" style="text-align:right; margin-top: 6px">
          <button onclick="editInfo(${lat}, ${lng})">✏️</button>
          <button onclick="addImage(${lat}, ${lng})">📷</button>
          <button onclick="setDestination(${lat}, ${lng})">📍</button>
          <button onclick="deleteMarker(${lat}, ${lng})">🗑️</button>
        </div>
      `;
    }

    function findMarker(lat, lng) {
      return markers.find(m => m.getLatLng().lat === lat && m.getLatLng().lng === lng);
    }

    function applyColor(color, lat, lng) {
      const marker = findMarker(lat, lng);
      if (marker) {
        marker.setIcon(getIcon(color));
        marker.customData.color = color;
        marker.bindPopup(getPopupContent(marker)).openPopup();
      }
    }

    function editInfo(lat, lng) {
      const marker = findMarker(lat, lng);
      if (marker) {
        const newName = prompt("Nhập tên mới:", marker.customData.name);
        if (newName) {
          marker.customData.name = newName;
          marker.bindPopup(getPopupContent(marker)).openPopup();
        }
      }
    }

    function addImage(lat, lng) {
      const url = prompt("Nhập URL hình ảnh:");
      const marker = findMarker(lat, lng);
      if (marker && url) {
        marker.customData.image = url;
        marker.bindPopup(getPopupContent(marker)).openPopup();
      }
    }

    function setDestination(lat, lng) {
      if (destinationMarker) destinationMarker.setOpacity(1);
      const marker = findMarker(lat, lng);
      if (marker) {
        destinationMarker = marker;
        marker.setOpacity(0.6);
        alert("Đã đặt làm điểm đến");
      }
    }

    function deleteMarker(lat, lng) {
      if (!confirm("Bạn có chắc muốn xóa marker này không?")) return;
      const marker = findMarker(lat, lng);
      if (marker) {
        map.removeLayer(marker);
        markers = markers.filter(m => m !== marker);
      }
    }

    async function loadData() {
      try {
        const resp = await fetch(DATA_URL);
        const data = await resp.json();

        if (!Array.isArray(data)) {
          console.error("Dữ liệu trả về không phải mảng:", data);
          return;
        }

        data.forEach(item => {
          const lat = parseFloat(item.lat);
          const lng = parseFloat(item.lng);
          if (isNaN(lat) || isNaN(lng)) return;

          const marker = L.marker([lat, lng], {
            icon: getIcon("blue")
          }).addTo(map);

          marker.customData = {
            name: item.name || "Không rõ",
            address: item.address || "Chưa có địa chỉ",
            contract: item.contract || "",
            lat: lat,
            lng: lng,
            image: "",
            color: "blue"
          };

          marker.bindPopup(getPopupContent(marker));
          markers.push(marker);
        });
      } catch (err) {
        console.error("Lỗi khi tải dữ liệu:", err);
      }
    }

    function setupSearch() {
      const input = document.getElementById("searchInput");
      input.addEventListener("input", () => {
        const kw = input.value.toLowerCase().trim();
        markers.forEach(m => {
          const text = `${m.customData.name} ${m.customData.address} ${m.customData.contract}`.toLowerCase();
          if (text.includes(kw)) {
            m.addTo(map);
          } else {
            map.removeLayer(m);
          }
        });
      });
    }

    window.onload = () => {
      loadData().then(setupSearch);
    };
  </script>
</body>
</html>
